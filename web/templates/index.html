<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Taxonomic Database</title>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
        <style>
            .species-card {
                border: 1px solid #ccc;
                border-radius: 8px;
                padding: 15px;
                margin-bottom: 20px;
            }
            .tag {
                background-color: #e9ecef;
                padding: 3px 8px;
                border-radius: 12px;
                margin-right: 5px;
                display: inline-block;
                margin-top: 5px;
            }
            .scientific-name {
                font-style: italic;
            }
    
            /* Phylogenetic Tree Styles */
            .taxonomy-path {
                background-color: #f8f9fa;
                border: 1px solid #dee2e6;
                border-radius: 6px;
            }
    
            #current-path .badge {
                font-size: 0.85rem;
                padding: 6px 10px;
            }
    
            #rank-options {
                gap: 8px;
            }
    
            #rank-options button {
                transition: all 0.2s ease;
            }
    
            #rank-options button:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            }
    
            .phylo-level-indicator {
                display: flex;
                align-items: center;
                margin-bottom: 20px;
            }
    
            .phylo-level-indicator .level-item {
                flex: 1;
                text-align: center;
                padding: 8px 0;
                position: relative;
            }
    
            .phylo-level-indicator .level-item::after {
                content: '';
                position: absolute;
                top: 50%;
                right: 0;
                height: 2px;
                width: 100%;
                background-color: #dee2e6;
                z-index: 1;
            }
    
            .phylo-level-indicator .level-item:last-child::after {
                display: none;
            }
    
            .phylo-level-indicator .level-item .level-marker {
                width: 30px;
                height: 30px;
                background-color: #f8f9fa;
                border: 2px solid #dee2e6;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 0 auto;
                position: relative;
                z-index: 2;
            }
    
            .phylo-level-indicator .level-item.active .level-marker {
                background-color: #0d6efd;
                border-color: #0d6efd;
                color: white;
            }
    
            .phylo-level-indicator .level-item.completed .level-marker {
                background-color: #198754;
                border-color: #198754;
                color: white;
            }
        </style>
    </head>
<body>
    <div class="container mt-4">
        <h1>Taxonomic Explorer</h1>
        
        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="explorer-tab" data-bs-toggle="tab" data-bs-target="#explorer" type="button" role="tab">Explorer</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="phylo-tab" data-bs-toggle="tab" data-bs-target="#phylo" type="button" role="tab">Phylogenetic Tree</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="add-tab" data-bs-toggle="tab" data-bs-target="#add" type="button" role="tab">Add Species</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="import-export-tab" data-bs-toggle="tab" data-bs-target="#import-export" type="button" role="tab">Import/Export</button>
            </li>
        </ul>
        
        <div class="tab-content" id="myTabContent">
            <!-- Explorer Tab -->
            <div class="tab-pane fade show active" id="explorer" role="tabpanel">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" id="search-input" class="form-control" placeholder="Search species...">
                            <button class="btn btn-primary" type="button" id="search-button">Search</button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div id="tag-filters" class="d-flex flex-wrap">
                            <!-- Tags will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <div id="species-container" class="row">
                    <!-- Species cards will be loaded here -->
                </div>
            </div>
            
            <!-- Phylogenetic Tree Tab -->    
            <div class="tab-pane fade" id="phylo" role="tabpanel">
                <h3>Phylogenetic Tree Explorer</h3>
                <p class="mb-4">Navigate the tree of life by selecting taxonomic ranks. Click "Show Species" at any point to view all species within the selected classification.</p>
                
                <!-- Progress indicator -->
                <div class="phylo-level-indicator mb-4">
                    <div class="level-item" id="level-domain">
                        <div class="level-marker">D</div>
                        <small>Domain</small>
                    </div>
                    <div class="level-item" id="level-kingdom">
                        <div class="level-marker">K</div>
                        <small>Kingdom</small>
                    </div>
                    <div class="level-item" id="level-phylum">
                        <div class="level-marker">P</div>
                        <small>Phylum</small>
                    </div>
                    <div class="level-item" id="level-class">
                        <div class="level-marker">C</div>
                        <small>Class</small>
                    </div>
                    <div class="level-item" id="level-order">
                        <div class="level-marker">O</div>
                        <small>Order</small>
                    </div>
                    <div class="level-item" id="level-family">
                        <div class="level-marker">F</div>
                        <small>Family</small>
                    </div>
                    <div class="level-item" id="level-genus">
                        <div class="level-marker">G</div>
                        <small>Genus</small>
                    </div>
                    <div class="level-item" id="level-species">
                        <div class="level-marker">S</div>
                        <small>Species</small>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-12 mb-4">
                        <div class="taxonomy-path card p-3 mb-3">
                            <h6>Current Selection:</h6>
                            <div id="current-path" class="d-flex flex-wrap align-items-center">
                                <span class="badge bg-secondary me-2 mb-2">All Life</span>
                            </div>
                        </div>
                        
                        <button id="show-species-btn" class="btn btn-success mb-3">Show Species</button>
                        <button id="reset-tree-btn" class="btn btn-outline-secondary mb-3 ms-2">Reset</button>
                        <button id="debug-tree-btn" class="btn btn-outline-danger mb-3 ms-2">Debug Tree</button>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span id="current-rank">Domain</span>
                                <div class="spinner-border spinner-border-sm text-primary d-none" id="rank-loading" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="rank-options" class="d-flex flex-wrap">
                                    <!-- Rank options will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="phylo-species-container" class="row">
                    <!-- Species cards will be loaded here when Show Species is clicked -->
                </div>
            </div>

            <!-- Add Species Tab -->
            <div class="tab-pane fade" id="add" role="tabpanel">
                <h3>Add New Species</h3>
                <form id="add-species-form">
                    <div class="row">
                        <div class="col-md-6">
                            <h4>Taxonomy</h4>
                            <div class="mb-3">
                                <label for="domain" class="form-label">Domain</label>
                                <input type="text" class="form-control" id="domain" required>
                            </div>
                            <div class="mb-3">
                                <label for="kingdom" class="form-label">Kingdom</label>
                                <input type="text" class="form-control" id="kingdom" required>
                            </div>
                            <div class="mb-3">
                                <label for="phylum" class="form-label">Phylum</label>
                                <input type="text" class="form-control" id="phylum" required>
                            </div>
                            <div class="mb-3">
                                <label for="class" class="form-label">Class</label>
                                <input type="text" class="form-control" id="class" required>
                            </div>
                            <div class="mb-3">
                                <label for="order" class="form-label">Order</label>
                                <input type="text" class="form-control" id="order" required>
                            </div>
                            <div class="mb-3">
                                <label for="family" class="form-label">Family</label>
                                <input type="text" class="form-control" id="family" required>
                            </div>
                            <div class="mb-3">
                                <label for="genus" class="form-label">Genus</label>
                                <input type="text" class="form-control" id="genus" required>
                            </div>
                            <div class="mb-3">
                                <label for="species-name" class="form-label">Species</label>
                                <input type="text" class="form-control" id="species-name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h4>Species Details</h4>
                            <div class="mb-3">
                                <label for="common-name" class="form-label">Common Name</label>
                                <input type="text" class="form-control" id="common-name">
                            </div>
                            <div class="mb-3">
                                <label for="description" class="form-label">Description</label>
                                <textarea class="form-control" id="description" rows="3"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="image-url" class="form-label">Image URL</label>
                                <input type="url" class="form-control" id="image-url">
                            </div>
                            <div class="mb-3">
                                <label for="distribution-map-url" class="form-label">Distribution Map URL</label>
                                <input type="url" class="form-control" id="distribution-map-url">
                            </div>
                            <div class="mb-3">
                                <label for="discovery-year" class="form-label">Discovery Year</label>
                                <input type="number" class="form-control" id="discovery-year">
                            </div>
                            <div class="mb-3">
                                <label for="conservation-status" class="form-label">Conservation Status</label>
                                <select class="form-control" id="conservation-status">
                                    <option value="">-- Select --</option>
                                    <option value="Not Evaluated">Not Evaluated</option>
                                    <option value="Data Deficient">Data Deficient</option>
                                    <option value="Least Concern">Least Concern</option>
                                    <option value="Near Threatened">Near Threatened</option>
                                    <option value="Vulnerable">Vulnerable</option>
                                    <option value="Endangered">Endangered</option>
                                    <option value="Critically Endangered">Critically Endangered</option>
                                    <option value="Extinct in the Wild">Extinct in the Wild</option>
                                    <option value="Extinct">Extinct</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="habitat" class="form-label">Habitat</label>
                                <input type="text" class="form-control" id="habitat">
                            </div>
                            <div class="mb-3">
                                <label for="tags" class="form-label">Tags (comma separated)</label>
                                <input type="text" class="form-control" id="tags">
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Species</button>
                </form>
            </div>
            
            <!-- Import/Export Tab -->
            <div class="tab-pane fade" id="import-export" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">Export Database</div>
                            <div class="card-body">
                                <p>Download the entire database as a JSON file.</p>
                                <button id="export-button" class="btn btn-primary">Export Database</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">Import Database</div>
                            <div class="card-body">
                                <p>Import database from a JSON file.</p>
                                <form id="import-form">
                                    <div class="mb-3">
                                        <input type="file" class="form-control" id="import-file" accept=".json">
                                    </div>
                                    <button type="submit" class="btn btn-primary">Import Database</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">SQL Schema</div>
                    <div class="card-body">
                        <p>Generate and download the SQL schema for the taxonomic database.</p>
                        <button id="schema-button" class="btn btn-primary">Get Schema</button>
                        <div class="mt-3">
                            <pre id="schema-content" class="bg-light p-3" style="display: none;"></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

   <!-- Taxonomy Description Modal -->
<div class="modal fade" id="taxonomyDescriptionModal" tabindex="-1" aria-labelledby="taxonomyDescriptionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taxonomyDescriptionModalLabel">Confirm Selection</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h4 id="taxonomy-item-name" class="mb-3"></h4>
                <div class="taxonomy-rank-badge mb-3">
                    <span id="taxonomy-rank" class="badge bg-secondary"></span>
                </div>
                <div class="description-container">
                    <h6>Description:</h6>
                    <p id="taxonomy-item-description">No description available.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Back to Selection</button>
                <button type="button" class="btn btn-primary" id="confirm-taxonomy-selection">Confirm Selection</button>
            </div>
        </div>
    </div>
</div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Phylogenetic Tree variables
        let currentPath = [];
        let currentRank = 'domain';
        let rankOrder = ['domain', 'kingdom', 'phylum', 'class', 'order', 'family', 'genus', 'species'];

        // JavaScript to interact with the API
        document.addEventListener('DOMContentLoaded', function() {
            // Load species and tags on page load
            loadSpecies();
            loadTags();
            
            // Search button click
            document.getElementById('search-button').addEventListener('click', function() {
                const searchTerm = document.getElementById('search-input').value;
                loadSpecies(searchTerm);
            });
            
            // Add species form submission
            document.getElementById('add-species-form').addEventListener('submit', function(e) {
                e.preventDefault();
                addSpecies();
            });
            
            // Export button click
            document.getElementById('export-button').addEventListener('click', function() {
                exportDatabase();
            });
            
            // Import form submission
            document.getElementById('import-form').addEventListener('submit', function(e) {
                e.preventDefault();
                importDatabase();
            });
            
            // Schema button click
            document.getElementById('schema-button').addEventListener('click', function() {
                getSchema();
            });
            
            // Initialize the phylogenetic tree when the tab is clicked
            if (document.getElementById('phylo-tab')) {
                document.getElementById('phylo-tab').addEventListener('click', function() {
                    console.log("Phylo tab clicked - initializing tree");
                    setTimeout(function() {
                        initPhylogeneticTree();
                    }, 100);
                });
            }  // Added the missing closing bracket here
            
            // Show Species button click
            if (document.getElementById('show-species-btn')) {
                document.getElementById('show-species-btn').addEventListener('click', function() {
                    console.log("Show species button clicked");
                    showSpeciesForCurrentSelection();
                });
            }
            
            // Reset Tree button click
            if (document.getElementById('reset-tree-btn')) {
                document.getElementById('reset-tree-btn').addEventListener('click', function() {
                    console.log("Reset tree button clicked");
                    resetPhylogeneticTree();
                });
            }
            
            // Debug Tree button click
            if (document.getElementById('debug-tree-btn')) {
                document.getElementById('debug-tree-btn').addEventListener('click', function() {
                    console.log("Debug button clicked");
                    
                    // Output current state
                    console.log("Current path:", currentPath);
                    console.log("Current rank:", currentRank);
                    
                    // Force reload domains
                    currentPath = [];
                    currentRank = 'domain';
                    
                    // Check if API is returning data
                    fetch('/api/taxonomic-rank/domain')
                        .then(response => response.json())
                        .then(data => {
                            console.log("API domain data:", data);
                            
                            if (!data || data.length === 0) {
                                alert("API returned no domain data. Check server logs.");
                            } else {
                                alert(`API returned ${data.length} domains. Check console for details.`);
                                loadRankOptions();
                            }
                        })
                        .catch(error => {
                            console.error("API error:", error);
                            alert("API error - check console");
                        });
                });
            }
        });

        // Initialize the phylogenetic tree
        function initPhylogeneticTree() {
            // Clear any existing path
            currentPath = [];
            currentRank = 'domain';
            
            // Update UI
            updateCurrentPathDisplay();
            
            // Set domain as active in progress indicator
            rankOrder.forEach(rank => {
                const item = document.getElementById(`level-${rank}`);
                item.classList.remove('active', 'completed');
            });
            const domainItem = document.getElementById('level-domain');
            domainItem.classList.add('active');
            
            // Disable the Show Species button until a selection is made
            document.getElementById('show-species-btn').disabled = false;
            
            // Load rank options
            loadRankOptions();
        }

        // Reset the phylogenetic tree
        function resetPhylogeneticTree() {
            console.log("Resetting phylogenetic tree");
            
            // Clear any existing path
            currentPath = [];
            currentRank = 'domain';
            
            // Update UI
            updateCurrentPathDisplay();
            
            // Clear species display
            document.getElementById('phylo-species-container').innerHTML = '';
            
            // Reset progress indicator
            rankOrder.forEach(rank => {
                const item = document.getElementById(`level-${rank}`);
                item.classList.remove('active', 'completed');
            });
            
            // Set domain as active
            const domainItem = document.getElementById('level-domain');
            domainItem.classList.add('active');
            
            // Disable the Show Species button 
            document.getElementById('show-species-btn').disabled = true;
            
            // Load rank options
            loadRankOptions();
        }
        
        // Update the current path display and progress indicator
        function updateCurrentPathDisplay() {
            const pathContainer = document.getElementById('current-path');
            pathContainer.innerHTML = '';
            
            // Always show "All Life" as the starting point
            const allLifeBadge = document.createElement('span');
            allLifeBadge.className = 'badge bg-secondary me-2 mb-2';
            allLifeBadge.textContent = 'All Life';
            pathContainer.appendChild(allLifeBadge);
            
            // Add each item in the current path
            currentPath.forEach((item, index) => {
                const badge = document.createElement('span');
                badge.className = 'badge bg-primary me-2 mb-2';
                badge.textContent = `${rankOrder[index]}: ${item.name}`;
                pathContainer.appendChild(badge);
            });
            
            // Update current rank display
            document.getElementById('current-rank').textContent = 
                currentRank.charAt(0).toUpperCase() + currentRank.slice(1);
            
            // Update progress indicator
            updateProgressIndicator();
        }

        // Update the progress indicator
        function updateProgressIndicator() {
            // Reset all items
            rankOrder.forEach(rank => {
                const item = document.getElementById(`level-${rank}`);
                item.classList.remove('active', 'completed');
            });
            
            // Mark completed items
            currentPath.forEach((item, index) => {
                const rank = rankOrder[index];
                const element = document.getElementById(`level-${rank}`);
                element.classList.add('completed');
            });
            
            // Mark active item (current rank)
            const currentItem = document.getElementById(`level-${currentRank}`);
            currentItem.classList.add('active');
        }

        // Helper function to create option buttons
        function createOptionButton(item, isPrimary = true) {
            const button = document.createElement('button');
            button.className = isPrimary ? 
                'btn btn-outline-primary me-2 mb-2' : 
                'btn btn-outline-secondary me-2 mb-2';
            button.textContent = item.name;
            button.dataset.id = item.id;
            
            // Also store description if available
            if (item.description) {
                button.dataset.description = item.description;
            }
            
            button.addEventListener('click', function() {
                selectRankOption({
                    id: item.id,
                    name: item.name,
                    description: item.description || ''
                });
            });
            
            return button;
        }

        // Helper function to clean up any stuck modals
        function cleanupModals() {
            // Remove all modal backdrops
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());
            
            // Reset body classes and styles
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('overflow');
            document.body.style.removeProperty('padding-right');
            
            // Hide any open modals
            const modalElements = document.querySelectorAll('.modal.show');
            modalElements.forEach(modalEl => {
                modalEl.classList.remove('show');
                modalEl.style.display = 'none';
                modalEl.setAttribute('aria-hidden', 'true');
                modalEl.removeAttribute('aria-modal');
                modalEl.removeAttribute('role');
            });
        }

        // Load options for the current rank
        function loadRankOptions() {
            const optionsContainer = document.getElementById('rank-options');
            const loadingSpinner = document.getElementById('rank-loading');
            
            // Show loading spinner
            optionsContainer.innerHTML = '';
            loadingSpinner.classList.remove('d-none');
            
            console.log("Loading rank options for rank:", currentRank);
            
            // Determine URL for API call and parameters
            let url = `/api/taxonomic-rank/${currentRank}`;
            
            if (currentPath.length > 0) {
                // If we have a path, get the parent rank and ID
                const parentRankIndex = rankOrder.indexOf(currentRank) - 1;
                if (parentRankIndex >= 0) {
                    const parentRank = rankOrder[parentRankIndex];
                    const parentId = currentPath[parentRankIndex].id;
                    url += `?parent_rank=${parentRank}&parent_id=${parentId}`;
                }
            }
            
            console.log("Fetching rank options from:", url);
            
            // Special handling for domain level at the start
            if (currentRank === 'domain' && !currentPath.length) {
                console.log("Initial domain loading");
                
                // Add a fallback for domain data if API fails
                const fallbackDomainData = [
                    { id: "domain-bacteria", name: "Bacteria", description: "Single-celled prokaryotic microorganisms" },
                    { id: "domain-archaea", name: "Archaea", description: "Single-celled microorganisms similar to bacteria but with different cell structure" },
                    { id: "domain-eukarya", name: "Eukarya", description: "Organisms whose cells have a nucleus enclosed within a nuclear envelope" }
                ];
                
                fetch(url)
                    .then(response => {
                        console.log("Domain API response status:", response.status);
                        return response.json();
                    })
                    .then(domains => {
                        // Hide loading spinner
                        loadingSpinner.classList.add('d-none');
                        
                        console.log("Domain data received:", domains);
                        
                        // If no domains were returned or the data is invalid, use fallback data
                        if (!domains || domains.length === 0 || !Array.isArray(domains)) {
                            console.warn("Using fallback domain data because API returned no valid data");
                            domains = fallbackDomainData;
                        }
                        
                        // Display options
                        // For domains, show the main three to start with
                        const mainDomains = ['Archaea', 'Bacteria', 'Eukarya'];
                        
                        // First show the main domains
                        mainDomains.forEach(domainName => {
                            const domain = domains.find(d => d.name && d.name.toLowerCase() === domainName.toLowerCase());
                            if (domain) {
                                optionsContainer.appendChild(createOptionButton(domain, true));
                            } else {
                                console.warn(`Domain ${domainName} not found in API data`);
                            }
                        });
                        
                        // Then show any other domains
                        domains.forEach(domain => {
                            if (domain.name && !mainDomains.find(m => m.toLowerCase() === domain.name.toLowerCase())) {
                                optionsContainer.appendChild(createOptionButton(domain, false));
                            }
                        });
                        
                        // If no buttons were created, show an error message
                        if (optionsContainer.children.length === 0) {
                            optionsContainer.innerHTML = '<p>No domains available. Please try refreshing the page.</p>';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading domains:', error);
                        loadingSpinner.classList.add('d-none');
                        
                        // Use fallback domain data if the API fails
                        console.warn("Using fallback domain data due to API error");
                        const domains = fallbackDomainData;
                        
                        domains.forEach(domain => {
                            optionsContainer.appendChild(createOptionButton(domain, true));
                        });
                    });
                return;
            }
    
    // For other ranks
    fetch(url)
        .then(response => response.json())
        .then(rankData => {
            // Hide loading spinner
            loadingSpinner.classList.add('d-none');
            
            console.log("Rank data received:", rankData);
            
            // Display options
            if (!rankData || rankData.length === 0) {
                optionsContainer.innerHTML = '<p>No options available at this level.</p>';
            } else {
                // For kingdoms, highlight the main five
                if (currentRank === 'kingdom') {
                    const mainKingdoms = ['Monera', 'Protista', 'Fungi', 'Plantae', 'Animalia'];
                    
                    // First show the main kingdoms
                    mainKingdoms.forEach(kingdomName => {
                        const kingdom = rankData.find(k => k.name && k.name.toLowerCase() === kingdomName.toLowerCase());
                        if (kingdom) {
                            optionsContainer.appendChild(createOptionButton(kingdom, true));
                        }
                    });
                    
                    // Then show any other kingdoms
                    rankData.forEach(kingdom => {
                        if (kingdom.name && !mainKingdoms.find(m => m.toLowerCase() === kingdom.name.toLowerCase())) {
                            optionsContainer.appendChild(createOptionButton(kingdom, false));
                        }
                    });
                } else {
                    // For other ranks, show all options
                    rankData.forEach(item => {
                        optionsContainer.appendChild(createOptionButton(item, true));
                    });
                }
            }
        })
        .catch(error => {
            console.error('Error loading rank options:', error);
            loadingSpinner.classList.add('d-none');
            optionsContainer.innerHTML = '<p class="text-danger">Error loading options. Please try again.</p>';
        });
}

        // Handle selection of a rank option
        function selectRankOption(item) {
            // Get the modal element
            const modalElement = document.getElementById('taxonomyDescriptionModal');
            
            // Clear any existing event listeners to prevent duplicates
            const confirmButton = document.getElementById('confirm-taxonomy-selection');
            const newConfirmButton = confirmButton.cloneNode(true);
            confirmButton.parentNode.replaceChild(newConfirmButton, confirmButton);
            
            // Set the item details in the modal
            document.getElementById('taxonomy-item-name').textContent = item.name || "Unknown";
            document.getElementById('taxonomy-rank').textContent = currentRank.charAt(0).toUpperCase() + currentRank.slice(1);
            
            // Set description or default message
            const descriptionElement = document.getElementById('taxonomy-item-description');
            if (item.description && item.description.trim() !== '') {
                descriptionElement.textContent = item.description;
            } else {
                descriptionElement.textContent = 'No description available for this ' + currentRank + '.';
            }
            
            // Store the item temporarily
            modalElement.dataset.itemId = item.id;
            modalElement.dataset.itemName = item.name || "Unknown";
            
            // Create Bootstrap modal instance
            const modal = new bootstrap.Modal(modalElement);
            
            // Add click handler for confirm button
            newConfirmButton.addEventListener('click', function() {
                const storedItem = {
                    id: modalElement.dataset.itemId,
                    name: modalElement.dataset.itemName
                };
                
                // Add selected item to path
                const currentRankIndex = rankOrder.indexOf(currentRank);
                
                // Truncate path to current rank
                currentPath = currentPath.slice(0, currentRankIndex);
                
                // Add new selection
                currentPath.push({
                    rank: currentRank,
                    id: storedItem.id,
                    name: storedItem.name
                });
                
                console.log("Updated path:", currentPath);
                
                // Move to next rank if available
                if (currentRankIndex < rankOrder.length - 1) {
                    currentRank = rankOrder[currentRankIndex + 1];
                }
                
                // Update UI
                updateCurrentPathDisplay();
                loadRankOptions();
                
                // Enable the Show Species button - this is the key change
                document.getElementById('show-species-btn').disabled = false;
                
                // Close the modal
                modal.hide();
                
                // Clean up modal backdrop
                setTimeout(function() {
                    const backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) {
                        backdrop.remove();
                    }
                    
                    // Reset body
                    document.body.classList.remove('modal-open');
                    document.body.style.removeProperty('overflow');
                    document.body.style.removeProperty('padding-right');
                }, 200); // small delay to ensure modal is completely hidden
            });
            
            // Show the modal
            modal.show();
        }

        // Show species for the current selection
        function showSpeciesForCurrentSelection() {
            const container = document.getElementById('phylo-species-container');
            const loadingSpinner = document.getElementById('rank-loading');
            
            // Show loading spinner
            container.innerHTML = '<div class="col-12 text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
            
            if (currentPath.length === 0) {
                // If no selection, show all species
                loadAllSpecies(container);
                return;
            }
            
            // Get the most specific rank selected
            const lastSelection = currentPath[currentPath.length - 1];
            const rank = lastSelection.rank;
            const rankId = lastSelection.id;
            
            // Use the new API endpoint if available
            fetch(`/api/species-by-rank/${rank}/${rankId}`)
                .then(response => {
                    // Check if endpoint exists
                    if (response.ok) {
                        return response.json();
                    } else {
                        // Fall back to search method
                        console.log('Species by rank endpoint not available, falling back to search');
                        return fallbackSpeciesSearch(lastSelection.name);
                    }
                })
                .then(data => {
                    renderSpeciesList(container, data);
                })
                .catch(error => {
                    console.error('Error loading species:', error);
                    // Try fallback method
                    fallbackSpeciesSearch(lastSelection.name)
                        .then(data => {
                            renderSpeciesList(container, data);
                        })
                        .catch(error => {
                            console.error('Error with fallback search:', error);
                            container.innerHTML = '<div class="col-12"><p class="text-danger">Error loading species. Please try again.</p></div>';
                        });
                });
        }

        // Fallback method to search species by name
        function fallbackSpeciesSearch(searchTerm) {
            return fetch(`/api/species?search=${encodeURIComponent(searchTerm)}`)
                .then(response => response.json());
        }

        // Load all species
        function loadAllSpecies(container) {
            fetch('/api/species')
                .then(response => response.json())
                .then(data => {
                    renderSpeciesList(container, data);
                })
                .catch(error => {
                    console.error('Error loading species:', error);
                    container.innerHTML = '<div class="col-12"><p class="text-danger">Error loading species. Please try again.</p></div>';
                });
        }

        // Render species list
        function renderSpeciesList(container, data) {
            container.innerHTML = '';
            
            if (data.length === 0) {
                container.innerHTML = '<div class="col-12"><p>No species found for the current selection.</p></div>';
                return;
            }
            
            // Display count
            const countRow = document.createElement('div');
            countRow.className = 'col-12';
            countRow.innerHTML = `<p class="mb-3">Found ${data.length} species</p>`;
            container.appendChild(countRow);
            
            // Display each species
            data.forEach(species => {
                const card = document.createElement('div');
                card.className = 'col-md-4 mb-4';
                
                let tagsHtml = '';
                if (species.tags) {
                    if (Array.isArray(species.tags)) {
                        tagsHtml = species.tags.map(tag => `<span class="tag">${tag}</span>`).join('');
                    } else if (typeof species.tags === 'string') {
                        tagsHtml = species.tags.split(',').map(tag => `<span class="tag">${tag.trim()}</span>`).join('');
                    }
                }
                
                // Add a map icon badge if distribution map is available
                const mapBadge = species.distribution_map_url 
                    ? '<span class="badge bg-info text-white position-absolute top-0 end-0 m-2" title="Distribution map available"><i class="bi bi-map"></i> Map</span>' 
                    : '';
                
                card.innerHTML = `
                    <div class="species-card position-relative">
                        ${mapBadge}
                        ${species.image_url ? `<img src="${species.image_url}" alt="${species.common_name || species.name}" class="img-fluid mb-2">` : ''}
                        <h4>${species.common_name || 'Unknown'}</h4>
                        <p class="scientific-name">${species.genus_name || ''} ${species.name}</p>
                        <p>${species.description ? species.description.substring(0, 100) + '...' : 'No description available.'}</p>
                        <div class="tags">
                            ${tagsHtml}
                        </div>
                        <button class="btn btn-sm btn-outline-primary mt-2" onclick="viewSpeciesDetails('${species.id}')">View Details</button>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

       // Load species with optional search term or tag
function loadSpecies(searchTerm = '', tagName = '') {
    let url = '/api/species';
    
    // Handle the API call differently based on what parameters we have
    if (searchTerm !== '') {
        // If we have a non-empty search term
        url += `?search=${encodeURIComponent(searchTerm)}`;
    } else if (tagName !== '') {
        // If we have a tag name
        url += `?tag=${encodeURIComponent(tagName)}`;
    } else {
        // For initial load, we want all species, not tags
        // Use a unique, specific parameter that will ensure we get species
        url += '?all=true';
    }
    
    console.log("Fetching species from:", url);
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            console.log("Species data received:", data);
            
            const container = document.getElementById('species-container');
            container.innerHTML = '';
            
            // Validate that we received species data, not tags
            if (!data || data.length === 0) {
                container.innerHTML = '<div class="col-12"><p>No species found.</p></div>';
                return;
            }
            
            // Check if we got tag data instead of species data
            if (data[0] && !data[0].hasOwnProperty('name') && !data[0].hasOwnProperty('common_name')) {
                console.warn("Received incorrect data type - forcing species search");
                loadSpecies(" "); // Force a search with a space to get species
                return;
            }
            
            // Render species cards
            data.forEach(species => {
                const card = document.createElement('div');
                card.className = 'col-md-4';
                
                let tagsHtml = '';
                if (species.tags) {
                    if (Array.isArray(species.tags)) {
                        tagsHtml = species.tags.map(tag => `<span class="tag">${tag}</span>`).join('');
                    } else if (typeof species.tags === 'string') {
                        tagsHtml = species.tags.split(',').map(tag => `<span class="tag">${tag.trim()}</span>`).join('');
                    }
                }
                
                // Add a map icon badge if distribution map is available
                const mapBadge = species.distribution_map_url 
                    ? '<span class="badge bg-info text-white position-absolute top-0 end-0 m-2" title="Distribution map available"><i class="bi bi-map"></i> Map</span>' 
                    : '';
                
                card.innerHTML = `
                    <div class="species-card position-relative">
                        ${mapBadge}
                        ${species.image_url ? `<img src="${species.image_url}" alt="${species.common_name || species.name}" class="img-fluid mb-2">` : ''}
                        <h4>${species.common_name || 'Unknown'}</h4>
                        <p class="scientific-name">${species.genus_name || ''} ${species.name}</p>
                        <p>${species.description ? species.description.substring(0, 100) + '...' : 'No description available.'}</p>
                        <div class="tags">
                            ${tagsHtml}
                        </div>
                        <button class="btn btn-sm btn-outline-primary mt-2" onclick="viewSpeciesDetails('${species.id}')">View Details</button>
                    </div>
                `;
                
                container.appendChild(card);
            });
        })
        .catch(error => {
            console.error('Error loading species:', error);
        });
}

        // Load tags
        function loadTags() {
            fetch('/api/tags')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('tag-filters');
                    container.innerHTML = '<span class="me-2">Filter by tag:</span>';
                    
                    data.forEach(tag => {
                        const tagButton = document.createElement('button');
                        tagButton.className = 'btn btn-sm btn-outline-secondary me-1 mb-1';
                        tagButton.textContent = tag.name;
                        tagButton.addEventListener('click', function() {
                            loadSpecies('', tag.name);
                        });
                        
                        container.appendChild(tagButton);
                    });
                })
                .catch(error => {
                    console.error('Error loading tags:', error);
                });
        }
        
        // Add new species
        function addSpecies() {
            const speciesData = {
                domain: document.getElementById('domain').value,
                kingdom: document.getElementById('kingdom').value,
                phylum: document.getElementById('phylum').value,
                class: document.getElementById('class').value,
                order: document.getElementById('order').value,
                family: document.getElementById('family').value,
                genus: document.getElementById('genus').value,
                species_name: document.getElementById('species-name').value,
                common_name: document.getElementById('common-name').value,
                description: document.getElementById('description').value,
                image_url: document.getElementById('image-url').value,
                distribution_map_url: document.getElementById('distribution-map-url').value,
                discovery_year: document.getElementById('discovery-year').value,
                conservation_status: document.getElementById('conservation-status').value,
                habitat: document.getElementById('habitat').value,
                tags: document.getElementById('tags').value.split(',').map(tag => tag.trim()).filter(tag => tag)
            };
            
            fetch('/api/species', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(speciesData)
            })
            .then(response => response.json())
            .then(data => {
                alert('Species added successfully!');
                document.getElementById('add-species-form').reset();
                
                // Switch back to explorer tab and refresh
                document.getElementById('explorer-tab').click();
                loadSpecies();
                loadTags();
            })
            .catch(error => {
                console.error('Error adding species:', error);
                alert('Error adding species. Please try again.');
            });
        }
        
        // View species details
        function viewSpeciesDetails(speciesId) {
            fetch(`/api/species/${speciesId}`)
                .then(response => response.json())
                .then(data => {
                    console.log("Species details data:", data); // Debug line
                    
                    // Create a modal to display detailed information
                    const modal = document.createElement('div');
                    modal.className = 'modal fade';
                    modal.id = 'speciesModal';
                    modal.setAttribute('tabindex', '-1');
                    
                    const tagsHtml = Array.isArray(data.tags) 
                        ? data.tags.map(tag => `<span class="tag">${tag}</span>`).join('')
                        : '';
                    
                    // Create distribution map section
                    const distributionMapSection = data.distribution_map_url 
                        ? `<div class="mt-3">
                             <h6>Distribution Map</h6>
                             <img src="${data.distribution_map_url}" alt="Distribution map for ${data.common_name || ''}" class="img-fluid border rounded">
                           </div>`
                        : '';
                    
                    // Handle different field names for species name
                    const speciesName = data.species_name || data.name || '';
                    const genusName = data.genus_name || '';
                    
                    // Create taxonomic tables only if data is available
                    const taxonomyTable = data.domain_name 
                        ? `<h6>Taxonomic Classification</h6>
                           <table class="table table-bordered">
                               ${data.domain_name ? `<tr><th>Domain</th><td>${data.domain_name}</td></tr>` : ''}
                               ${data.kingdom_name ? `<tr><th>Kingdom</th><td>${data.kingdom_name}</td></tr>` : ''}
                               ${data.phylum_name ? `<tr><th>Phylum</th><td>${data.phylum_name}</td></tr>` : ''}
                               ${data.class_name ? `<tr><th>Class</th><td>${data.class_name}</td></tr>` : ''}
                               ${data.order_name ? `<tr><th>Order</th><td>${data.order_name}</td></tr>` : ''}
                               ${data.family_name ? `<tr><th>Family</th><td>${data.family_name}</td></tr>` : ''}
                               ${genusName ? `<tr><th>Genus</th><td>${genusName}</td></tr>` : ''}
                               ${speciesName ? `<tr><th>Species</th><td>${speciesName}</td></tr>` : ''}
                           </table>`
                        : '';
                    
                    // Create additional info table only if data is available
                    const additionalInfoTable = (data.discovery_year || data.conservation_status || data.habitat || data.geographic_distribution)
                        ? `<h6>Additional Information</h6>
                           <table class="table table-bordered">
                               ${data.discovery_year ? `<tr><th>Discovery Year</th><td>${data.discovery_year}</td></tr>` : ''}
                               ${data.conservation_status ? `<tr><th>Conservation Status</th><td>${data.conservation_status}</td></tr>` : ''}
                               ${data.habitat ? `<tr><th>Habitat</th><td>${data.habitat}</td></tr>` : ''}
                               ${data.geographic_distribution ? `<tr><th>Geographic Distribution</th><td>${data.geographic_distribution}</td></tr>` : ''}
                           </table>`
                        : '';
                    
                    modal.innerHTML = `
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">${data.common_name || 'Unknown'}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <h6 class="scientific-name">${genusName} ${speciesName}</h6>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            ${data.image_url ? `<img src="${data.image_url}" alt="${data.common_name || ''}" class="img-fluid mb-3">` : ''}
                                            <p>${data.description || 'No description available.'}</p>
                                            <div class="tags mb-3">
                                                ${tagsHtml}
                                            </div>
                                            ${distributionMapSection}
                                        </div>
                                        <div class="col-md-6">
                                            ${taxonomyTable}
                                            ${additionalInfoTable}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    
                    const modalInstance = new bootstrap.Modal(modal);
                    modalInstance.show();
                    
                    modal.addEventListener('hidden.bs.modal', function() {
                        modal.remove();
                    });
                })
                .catch(error => {
                    console.error('Error loading species details:', error);
                });
        }
        
        // Export database
        function exportDatabase() {
            fetch('/api/export')
                .then(response => response.json())
                .then(data => {
                    alert('Database exported successfully!');
                    window.location.href = '/taxonomy_export.json';
                })
                .catch(error => {
                    console.error('Error exporting database:', error);
                    alert('Error exporting database. Please try again.');
                });
        }
        
        // Import database
        function importDatabase() {
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file to import.');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            fetch('/api/import', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    alert('Database imported successfully!');
                    window.location.reload();
                }
            })
            .catch(error => {
                console.error('Error importing database:', error);
                alert('Error importing database. Please try again.');
            });
        }
        
        // Get SQL schema
        function getSchema() {
            fetch('/api/schema')
                .then(response => response.json())
                .then(data => {
                    const schemaContent = document.getElementById('schema-content');
                    schemaContent.textContent = data.schema;
                    schemaContent.style.display = 'block';
                    
                    // Create download link
                    const downloadLink = document.createElement('a');
                    downloadLink.href = 'data:text/plain;charset=utf-8,' + encodeURIComponent(data.schema);
                    downloadLink.download = 'taxonomy_schema.sql';
                    downloadLink.className = 'btn btn-outline-primary mt-2';
                    downloadLink.textContent = 'Download SQL Schema';
                    
                    const parentElement = schemaContent.parentElement;
                    if (parentElement.querySelector('a')) {
                        parentElement.querySelector('a').remove();
                    }
                    parentElement.appendChild(downloadLink);
                })
                .catch(error => {
                    console.error('Error getting schema:', error);
                    alert('Error getting schema. Please try again.');
                });
        }
    </script>
</body>
</html>