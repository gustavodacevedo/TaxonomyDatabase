<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taxonomic Database</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .species-card {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .tag {
            background-color: #e9ecef;
            padding: 3px 8px;
            border-radius: 12px;
            margin-right: 5px;
            display: inline-block;
            margin-top: 5px;
        }
        .scientific-name {
            font-style: italic;
        }

        /* Phylogenetic Tree Styles */
        .taxonomy-path {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
        }

        #current-path .badge {
            font-size: 0.85rem;
            padding: 6px 10px;
        }

        #rank-options {
            gap: 8px;
        }

        #rank-options button {
            transition: all 0.2s ease;
        }

        #rank-options button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .phylo-level-indicator {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .phylo-level-indicator .level-item {
            flex: 1;
            text-align: center;
            padding: 8px 0;
            position: relative;
        }

        .phylo-level-indicator .level-item::after {
            content: '';
            position: absolute;
            top: 50%;
            right: 0;
            height: 2px;
            width: 100%;
            background-color: #dee2e6;
            z-index: 1;
        }

        .phylo-level-indicator .level-item:last-child::after {
            display: none;
        }

        .phylo-level-indicator .level-item .level-marker {
            width: 30px;
            height: 30px;
            background-color: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            position: relative;
            z-index: 2;
        }

        .phylo-level-indicator .level-item.active .level-marker {
            background-color: #0d6efd;
            border-color: #0d6efd;
            color: white;
        }

        .phylo-level-indicator .level-item.completed .level-marker {
            background-color: #198754;
            border-color: #198754;
            color: white;
}
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>Taxonomic Explorer</h1>
        
        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="explorer-tab" data-bs-toggle="tab" data-bs-target="#explorer" type="button" role="tab">Explorer</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="phylo-tab" data-bs-toggle="tab" data-bs-target="#phylo" type="button" role="tab">Phylogenetic Tree</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="add-tab" data-bs-toggle="tab" data-bs-target="#add" type="button" role="tab">Add Species</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="import-export-tab" data-bs-toggle="tab" data-bs-target="#import-export" type="button" role="tab">Import/Export</button>
            </li>
        </ul>
        
        <div class="tab-content" id="myTabContent">
            <!-- Explorer Tab -->
            <div class="tab-pane fade show active" id="explorer" role="tabpanel">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" id="search-input" class="form-control" placeholder="Search species...">
                            <button class="btn btn-primary" type="button" id="search-button">Search</button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div id="tag-filters" class="d-flex flex-wrap">
                            <!-- Tags will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <div id="species-container" class="row">
                    <!-- Species cards will be loaded here -->
                </div>
            </div>
            
            <!-- Phylogenetic Tree Tab -->    
            <div class="tab-pane fade" id="phylo" role="tabpanel">
                <h3>Phylogenetic Tree Explorer</h3>
                <p class="mb-4">Navigate the tree of life by selecting taxonomic ranks. Click "Show Species" at any point to view all species within the selected classification.</p>
                
                <!-- Progress indicator -->
                <div class="phylo-level-indicator mb-4">
                    <div class="level-item" id="level-domain">
                        <div class="level-marker">D</div>
                        <small>Domain</small>
                    </div>
                    <div class="level-item" id="level-kingdom">
                        <div class="level-marker">K</div>
                        <small>Kingdom</small>
                    </div>
                    <div class="level-item" id="level-phylum">
                        <div class="level-marker">P</div>
                        <small>Phylum</small>
                    </div>
                    <div class="level-item" id="level-class">
                        <div class="level-marker">C</div>
                        <small>Class</small>
                    </div>
                    <div class="level-item" id="level-order">
                        <div class="level-marker">O</div>
                        <small>Order</small>
                    </div>
                    <div class="level-item" id="level-family">
                        <div class="level-marker">F</div>
                        <small>Family</small>
                    </div>
                    <div class="level-item" id="level-genus">
                        <div class="level-marker">G</div>
                        <small>Genus</small>
                    </div>
                    <div class="level-item" id="level-species">
                        <div class="level-marker">S</div>
                        <small>Species</small>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-12 mb-4">
                        <div class="taxonomy-path card p-3 mb-3">
                            <h6>Current Selection:</h6>
                            <div id="current-path" class="d-flex flex-wrap align-items-center">
                                <span class="badge bg-secondary me-2 mb-2">All Life</span>
                            </div>
                        </div>
                        
                        <button id="show-species-btn" class="btn btn-success mb-3">Show Species</button>
                        <button id="reset-tree-btn" class="btn btn-outline-secondary mb-3 ms-2">Reset</button>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span id="current-rank">Domain</span>
                                <div class="spinner-border spinner-border-sm text-primary d-none" id="rank-loading" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="rank-options" class="d-flex flex-wrap">
                                    <!-- Rank options will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="phylo-species-container" class="row">
                    <!-- Species cards will be loaded here when Show Species is clicked -->
                </div>
            </div>

            <!-- Add Species Tab -->
            <div class="tab-pane fade" id="add" role="tabpanel">
                <h3>Add New Species</h3>
                <form id="add-species-form">
                    <div class="row">
                        <div class="col-md-6">
                            <h4>Taxonomy</h4>
                            <div class="mb-3">
                                <label for="domain" class="form-label">Domain</label>
                                <input type="text" class="form-control" id="domain" required>
                            </div>
                            <div class="mb-3">
                                <label for="kingdom" class="form-label">Kingdom</label>
                                <input type="text" class="form-control" id="kingdom" required>
                            </div>
                            <div class="mb-3">
                                <label for="phylum" class="form-label">Phylum</label>
                                <input type="text" class="form-control" id="phylum" required>
                            </div>
                            <div class="mb-3">
                                <label for="class" class="form-label">Class</label>
                                <input type="text" class="form-control" id="class" required>
                            </div>
                            <div class="mb-3">
                                <label for="order" class="form-label">Order</label>
                                <input type="text" class="form-control" id="order" required>
                            </div>
                            <div class="mb-3">
                                <label for="family" class="form-label">Family</label>
                                <input type="text" class="form-control" id="family" required>
                            </div>
                            <div class="mb-3">
                                <label for="genus" class="form-label">Genus</label>
                                <input type="text" class="form-control" id="genus" required>
                            </div>
                            <div class="mb-3">
                                <label for="species-name" class="form-label">Species</label>
                                <input type="text" class="form-control" id="species-name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h4>Species Details</h4>
                            <div class="mb-3">
                                <label for="common-name" class="form-label">Common Name</label>
                                <input type="text" class="form-control" id="common-name">
                            </div>
                            <div class="mb-3">
                                <label for="description" class="form-label">Description</label>
                                <textarea class="form-control" id="description" rows="3"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="image-url" class="form-label">Image URL</label>
                                <input type="url" class="form-control" id="image-url">
                            </div>
                            <div class="mb-3">
                                <label for="discovery-year" class="form-label">Discovery Year</label>
                                <input type="number" class="form-control" id="discovery-year">
                            </div>
                            <div class="mb-3">
                                <label for="conservation-status" class="form-label">Conservation Status</label>
                                <select class="form-control" id="conservation-status">
                                    <option value="">-- Select --</option>
                                    <option value="Not Evaluated">Not Evaluated</option>
                                    <option value="Data Deficient">Data Deficient</option>
                                    <option value="Least Concern">Least Concern</option>
                                    <option value="Near Threatened">Near Threatened</option>
                                    <option value="Vulnerable">Vulnerable</option>
                                    <option value="Endangered">Endangered</option>
                                    <option value="Critically Endangered">Critically Endangered</option>
                                    <option value="Extinct in the Wild">Extinct in the Wild</option>
                                    <option value="Extinct">Extinct</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="habitat" class="form-label">Habitat</label>
                                <input type="text" class="form-control" id="habitat">
                            </div>
                            <div class="mb-3">
                                <label for="tags" class="form-label">Tags (comma separated)</label>
                                <input type="text" class="form-control" id="tags">
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Species</button>
                </form>
            </div>
            
            <!-- Import/Export Tab -->
            <div class="tab-pane fade" id="import-export" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">Export Database</div>
                            <div class="card-body">
                                <p>Download the entire database as a JSON file.</p>
                                <button id="export-button" class="btn btn-primary">Export Database</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">Import Database</div>
                            <div class="card-body">
                                <p>Import database from a JSON file.</p>
                                <form id="import-form">
                                    <div class="mb-3">
                                        <input type="file" class="form-control" id="import-file" accept=".json">
                                    </div>
                                    <button type="submit" class="btn btn-primary">Import Database</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">SQL Schema</div>
                    <div class="card-body">
                        <p>Generate and download the SQL schema for the taxonomic database.</p>
                        <button id="schema-button" class="btn btn-primary">Get Schema</button>
                        <div class="mt-3">
                            <pre id="schema-content" class="bg-light p-3" style="display: none;"></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // JavaScript to interact with the API
        document.addEventListener('DOMContentLoaded', function() {
            // Load species and tags on page load
            loadSpecies();
            loadTags();
            
            // Search button click
            document.getElementById('search-button').addEventListener('click', function() {
                const searchTerm = document.getElementById('search-input').value;
                loadSpecies(searchTerm);
            });
            
            // Add species form submission
            document.getElementById('add-species-form').addEventListener('submit', function(e) {
                e.preventDefault();
                addSpecies();
            });
            
            // Export button click
            document.getElementById('export-button').addEventListener('click', function() {
                exportDatabase();
            });
            
            // Import form submission
            document.getElementById('import-form').addEventListener('submit', function(e) {
                e.preventDefault();
                importDatabase();
            });
            
            // Schema button click
            document.getElementById('schema-button').addEventListener('click', function() {
                getSchema();
            });
        });
        
        // Phylogenetic Tree variables
let currentPath = [];
let currentRank = 'domain';
let rankOrder = ['domain', 'kingdom', 'phylum', 'class', 'order', 'family', 'genus', 'species'];

document.addEventListener('DOMContentLoaded', function() {
    // Add this to your existing event listener
    
    // Initialize the phylogenetic tree
    if (document.getElementById('phylo-tab')) {
        initPhylogeneticTree();
        
        // Show Species button click
        document.getElementById('show-species-btn').addEventListener('click', function() {
            showSpeciesForCurrentSelection();
        });
        
        // Reset Tree button click
        document.getElementById('reset-tree-btn').addEventListener('click', function() {
            resetPhylogeneticTree();
        });
    }
});

// Initialize the phylogenetic tree
function initPhylogeneticTree() {
    // Clear any existing path
    currentPath = [];
    currentRank = 'domain';
    
    // Update UI
    updateCurrentPathDisplay();
    
    // Set domain as active in progress indicator
    rankOrder.forEach(rank => {
        const item = document.getElementById(`level-${rank}`);
        item.classList.remove('active', 'completed');
    });
    const domainItem = document.getElementById('level-domain');
    domainItem.classList.add('active');
    
    // Load rank options
    loadRankOptions();
}

// Reset the phylogenetic tree
function resetPhylogeneticTree() {
    initPhylogeneticTree();
    // Clear species display
    document.getElementById('phylo-species-container').innerHTML = '';
    
    // Reset progress indicator
    rankOrder.forEach(rank => {
        const item = document.getElementById(`level-${rank}`);
        item.classList.remove('active', 'completed');
    });
    
    // Set domain as active
    const domainItem = document.getElementById('level-domain');
    domainItem.classList.add('active');
}

// Update the current path display and progress indicator
function updateCurrentPathDisplay() {
    const pathContainer = document.getElementById('current-path');
    pathContainer.innerHTML = '';
    
    // Always show "All Life" as the starting point
    const allLifeBadge = document.createElement('span');
    allLifeBadge.className = 'badge bg-secondary me-2 mb-2';
    allLifeBadge.textContent = 'All Life';
    pathContainer.appendChild(allLifeBadge);
    
    // Add each item in the current path
    currentPath.forEach((item, index) => {
        const badge = document.createElement('span');
        badge.className = 'badge bg-primary me-2 mb-2';
        badge.textContent = `${rankOrder[index]}: ${item.name}`;
        pathContainer.appendChild(badge);
    });
    
    // Update current rank display
    document.getElementById('current-rank').textContent = 
        currentRank.charAt(0).toUpperCase() + currentRank.slice(1);
    
    // Update progress indicator
    updateProgressIndicator();
}

// Update the progress indicator
function updateProgressIndicator() {
    // Reset all items
    rankOrder.forEach(rank => {
        const item = document.getElementById(`level-${rank}`);
        item.classList.remove('active', 'completed');
    });
    
    // Mark completed items
    currentPath.forEach((item, index) => {
        const rank = rankOrder[index];
        const element = document.getElementById(`level-${rank}`);
        element.classList.add('completed');
    });
    
    // Mark active item (current rank)
    const currentItem = document.getElementById(`level-${currentRank}`);
    currentItem.classList.add('active');
}

// Load options for the current rank
function loadRankOptions() {
    const optionsContainer = document.getElementById('rank-options');
    const loadingSpinner = document.getElementById('rank-loading');
    
    // Show loading spinner
    optionsContainer.innerHTML = '';
    loadingSpinner.classList.remove('d-none');
    
    // Determine URL for API call and parameters
    let url = '';
    let parentRank = '';
    let parentId = '';
    
    if (currentPath.length > 0) {
        // If we have a path, get the parent rank and ID
        const parentRankIndex = rankOrder.indexOf(currentRank) - 1;
        if (parentRankIndex >= 0) {
            parentRank = rankOrder[parentRankIndex];
            parentId = currentPath[parentRankIndex].id;
            url = `/api/taxonomic-rank/${currentRank}?parent_rank=${parentRank}&parent_id=${parentId}`;
        } else {
            url = `/api/taxonomic-rank/${currentRank}`;
        }
    } else {
        // If at the beginning (domain level), just get all domains
        url = `/api/taxonomic-rank/${currentRank}`;
    }
    
    // If using the existing endpoint before new ones are implemented
    if (currentRank === 'domain' && !currentPath.length) {
        // Initial load - use the existing endpoint to get all domains
        fetch('/api/taxonomy')
            .then(response => response.json())
            .then(data => {
                // Hide loading spinner
                loadingSpinner.classList.add('d-none');
                
                // Get domains data
                const domains = data.domains || [];
                
                // Display options
                if (domains.length === 0) {
                    optionsContainer.innerHTML = '<p>No domains available.</p>';
                } else {
                    // For domains, show the main three to start with
                    const mainDomains = ['Archaea', 'Bacteria', 'Eukarya'];
                    
                    // First show the main domains
                    mainDomains.forEach(domainName => {
                        const domain = domains.find(d => d.name.toLowerCase() === domainName.toLowerCase());
                        if (domain) {
                            const button = document.createElement('button');
                            button.className = 'btn btn-outline-primary me-2 mb-2';
                            button.textContent = domain.name;
                            button.dataset.id = domain.id;
                            button.addEventListener('click', function() {
                                selectRankOption(domain);
                            });
                            optionsContainer.appendChild(button);
                        }
                    });
                    
                    // Then show any other domains
                    domains.forEach(domain => {
                        if (!mainDomains.find(m => m.toLowerCase() === domain.name.toLowerCase())) {
                            const button = document.createElement('button');
                            button.className = 'btn btn-outline-secondary me-2 mb-2';
                            button.textContent = domain.name;
                            button.dataset.id = domain.id;
                            button.addEventListener('click', function() {
                                selectRankOption(domain);
                            });
                            optionsContainer.appendChild(button);
                        }
                    });
                }
            })
            .catch(error => {
                console.error('Error loading domains:', error);
                loadingSpinner.classList.add('d-none');
                optionsContainer.innerHTML = '<p class="text-danger">Error loading domains. Please try again.</p>';
            });
        return;
    }
    
    // For other ranks or when new endpoints are implemented
    fetch(url)
        .then(response => response.json())
        .then(rankData => {
            // Hide loading spinner
            loadingSpinner.classList.add('d-none');
            
            // Display options
            if (!rankData || rankData.length === 0) {
                optionsContainer.innerHTML = '<p>No options available at this level.</p>';
            } else {
                // For kingdoms, highlight the main five
                if (currentRank === 'kingdom') {
                    const mainKingdoms = ['Monera', 'Protista', 'Fungi', 'Plantae', 'Animalia'];
                    
                    // First show the main kingdoms
                    mainKingdoms.forEach(kingdomName => {
                        const kingdom = rankData.find(k => k.name.toLowerCase() === kingdomName.toLowerCase());
                        if (kingdom) {
                            const button = document.createElement('button');
                            button.className = 'btn btn-outline-primary me-2 mb-2';
                            button.textContent = kingdom.name;
                            button.dataset.id = kingdom.id;
                            button.addEventListener('click', function() {
                                selectRankOption(kingdom);
                            });
                            optionsContainer.appendChild(button);
                        }
                    });
                    
                    // Then show any other kingdoms
                    rankData.forEach(kingdom => {
                        if (!mainKingdoms.find(m => m.toLowerCase() === kingdom.name.toLowerCase())) {
                            const button = document.createElement('button');
                            button.className = 'btn btn-outline-secondary me-2 mb-2';
                            button.textContent = kingdom.name;
                            button.dataset.id = kingdom.id;
                            button.addEventListener('click', function() {
                                selectRankOption(kingdom);
                            });
                            optionsContainer.appendChild(button);
                        }
                    });
                } else {
                    // For other ranks, show all options
                    rankData.forEach(item => {
                        const button = document.createElement('button');
                        button.className = 'btn btn-outline-primary me-2 mb-2';
                        button.textContent = item.name;
                        button.dataset.id = item.id;
                        button.addEventListener('click', function() {
                            selectRankOption(item);
                        });
                        optionsContainer.appendChild(button);
                    });
                }
            }
        })
        .catch(error => {
            console.error('Error loading rank options:', error);
            loadingSpinner.classList.add('d-none');
            optionsContainer.innerHTML = '<p class="text-danger">Error loading options. Please try again.</p>';
        });
}

// Handle selection of a rank option
function selectRankOption(item) {
    // Add selected item to path
    const currentRankIndex = rankOrder.indexOf(currentRank);
    
    // Truncate path to current rank
    currentPath = currentPath.slice(0, currentRankIndex);
    
    // Add new selection
    currentPath.push({
        rank: currentRank,
        id: item.id,
        name: item.name
    });
    
    // Move to next rank if available
    if (currentRankIndex < rankOrder.length - 1) {
        currentRank = rankOrder[currentRankIndex + 1];
    }
    
    // Update UI
    updateCurrentPathDisplay();
    loadRankOptions();
}

// Show species for the current selection
function showSpeciesForCurrentSelection() {
    const container = document.getElementById('phylo-species-container');
    const loadingSpinner = document.getElementById('rank-loading');
    
    // Show loading spinner
    container.innerHTML = '<div class="col-12 text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
    
    if (currentPath.length === 0) {
        // If no selection, show all species
        loadAllSpecies(container);
        return;
    }
    
    // Get the most specific rank selected
    const lastSelection = currentPath[currentPath.length - 1];
    const rank = lastSelection.rank;
    const rankId = lastSelection.id;
    
    // Use the new API endpoint if available
    fetch(`/api/species-by-rank/${rank}/${rankId}`)
        .then(response => {
            // Check if endpoint exists
            if (response.ok) {
                return response.json();
            } else {
                // Fall back to search method
                console.log('Species by rank endpoint not available, falling back to search');
                return fallbackSpeciesSearch(lastSelection.name);
            }
        })
        .then(data => {
            renderSpeciesList(container, data);
        })
        .catch(error => {
            console.error('Error loading species:', error);
            // Try fallback method
            fallbackSpeciesSearch(lastSelection.name)
                .then(data => {
                    renderSpeciesList(container, data);
                })
                .catch(error => {
                    console.error('Error with fallback search:', error);
                    container.innerHTML = '<div class="col-12"><p class="text-danger">Error loading species. Please try again.</p></div>';
                });
        });
}

        // Fallback method to search species by name
        function fallbackSpeciesSearch(searchTerm) {
            return fetch(`/api/species?search=${encodeURIComponent(searchTerm)}`)
                .then(response => response.json());
        }

        // Load all species
        function loadAllSpecies(container) {
            fetch('/api/species')
                .then(response => response.json())
                .then(data => {
                    renderSpeciesList(container, data);
                })
                .catch(error => {
                    console.error('Error loading species:', error);
                    container.innerHTML = '<div class="col-12"><p class="text-danger">Error loading species. Please try again.</p></div>';
                });
        }

        // Render species list
        function renderSpeciesList(container, data) {
            container.innerHTML = '';
            
            if (data.length === 0) {
                container.innerHTML = '<div class="col-12"><p>No species found for the current selection.</p></div>';
                return;
            }
            
            // Display count
            const countRow = document.createElement('div');
            countRow.className = 'col-12';
            countRow.innerHTML = `<p class="mb-3">Found ${data.length} species</p>`;
            container.appendChild(countRow);
            
            // Display each species
            data.forEach(species => {
                const card = document.createElement('div');
                card.className = 'col-md-4 mb-4';
                
                let tagsHtml = '';
                if (species.tags) {
                    if (Array.isArray(species.tags)) {
                        tagsHtml = species.tags.map(tag => `<span class="tag">${tag}</span>`).join('');
                    } else if (typeof species.tags === 'string') {
                        tagsHtml = species.tags.split(',').map(tag => `<span class="tag">${tag.trim()}</span>`).join('');
                    }
                }
                
                card.innerHTML = `
                    <div class="species-card">
                        ${species.image_url ? `<img src="${species.image_url}" alt="${species.common_name || species.name}" class="img-fluid mb-2">` : ''}
                        <h4>${species.common_name || 'Unknown'}</h4>
                        <p class="scientific-name">${species.genus_name || ''} ${species.name}</p>
                        <p>${species.description ? species.description.substring(0, 100) + '...' : 'No description available.'}</p>
                        <div class="tags">
                            ${tagsHtml}
                        </div>
                        <button class="btn btn-sm btn-outline-primary mt-2" onclick="viewSpeciesDetails('${species.id}')">View Details</button>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        // Load species with optional search term or tag
        function loadSpecies(searchTerm = '', tagName = '') {
            let url = '/api/species';
            if (searchTerm) {
                url += `?search=${encodeURIComponent(searchTerm)}`;
            } else if (tagName) {
                url += `?tag=${encodeURIComponent(tagName)}`;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('species-container');
                    container.innerHTML = '';
                    
                    if (data.length === 0) {
                        container.innerHTML = '<div class="col-12"><p>No species found.</p></div>';
                        return;
                    }
                    
                    data.forEach(species => {
                        const card = document.createElement('div');
                        card.className = 'col-md-4';
                        
                        let tagsHtml = '';
                        if (species.tags) {
                            if (Array.isArray(species.tags)) {
                                tagsHtml = species.tags.map(tag => `<span class="tag">${tag}</span>`).join('');
                            } else if (typeof species.tags === 'string') {
                                tagsHtml = species.tags.split(',').map(tag => `<span class="tag">${tag.trim()}</span>`).join('');
                            }
                        }
                        
                        card.innerHTML = `
                            <div class="species-card">
                                ${species.image_url ? `<img src="${species.image_url}" alt="${species.common_name || species.name}" class="img-fluid mb-2">` : ''}
                                <h4>${species.common_name || 'Unknown'}</h4>
                                <p class="scientific-name">${species.genus_name || ''} ${species.name}</p>
                                <p>${species.description || 'No description available.'}</p>
                                <div class="tags">
                                    ${tagsHtml}
                                </div>
                                <button class="btn btn-sm btn-outline-primary mt-2" onclick="viewSpeciesDetails('${species.id}')">View Details</button>
                            </div>
                        `;
                        
                        container.appendChild(card);
                    });
                })
                .catch(error => {
                    console.error('Error loading species:', error);
                });
        }
        
        // Load tags
        function loadTags() {
            fetch('/api/tags')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('tag-filters');
                    container.innerHTML = '<span class="me-2">Filter by tag:</span>';
                    
                    data.forEach(tag => {
                        const tagButton = document.createElement('button');
                        tagButton.className = 'btn btn-sm btn-outline-secondary me-1 mb-1';
                        tagButton.textContent = tag.name;
                        tagButton.addEventListener('click', function() {
                            loadSpecies('', tag.name);
                        });
                        
                        container.appendChild(tagButton);
                    });
                })
                .catch(error => {
                    console.error('Error loading tags:', error);
                });
        }
        
        // Add new species
        function addSpecies() {
            const speciesData = {
                domain: document.getElementById('domain').value,
                kingdom: document.getElementById('kingdom').value,
                phylum: document.getElementById('phylum').value,
                class: document.getElementById('class').value,
                order: document.getElementById('order').value,
                family: document.getElementById('family').value,
                genus: document.getElementById('genus').value,
                species_name: document.getElementById('species-name').value,
                common_name: document.getElementById('common-name').value,
                description: document.getElementById('description').value,
                image_url: document.getElementById('image-url').value,
                discovery_year: document.getElementById('discovery-year').value,
                conservation_status: document.getElementById('conservation-status').value,
                habitat: document.getElementById('habitat').value,
                tags: document.getElementById('tags').value.split(',').map(tag => tag.trim()).filter(tag => tag)
            };
            
            fetch('/api/species', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(speciesData)
            })
            .then(response => response.json())
            .then(data => {
                alert('Species added successfully!');
                document.getElementById('add-species-form').reset();
                
                // Switch back to explorer tab and refresh
                document.getElementById('explorer-tab').click();
                loadSpecies();
                loadTags();
            })
            .catch(error => {
                console.error('Error adding species:', error);
                alert('Error adding species. Please try again.');
            });
        }
        
        // View species details
        function viewSpeciesDetails(speciesId) {
            fetch(`/api/species/${speciesId}`)
                .then(response => response.json())
                .then(data => {
                    // Create a modal to display detailed information
                    const modal = document.createElement('div');
                    modal.className = 'modal fade';
                    modal.id = 'speciesModal';
                    modal.setAttribute('tabindex', '-1');
                    
                    const tagsHtml = Array.isArray(data.tags) 
                        ? data.tags.map(tag => `<span class="tag">${tag}</span>`).join('')
                        : '';
                    
                    modal.innerHTML = `
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">${data.common_name || 'Unknown'}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <h6 class="scientific-name">${data.genus_name} ${data.species_name}</h6>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            ${data.image_url ? `<img src="${data.image_url}" alt="${data.common_name}" class="img-fluid mb-3">` : ''}
                                            <p>${data.description || 'No description available.'}</p>
                                            <div class="tags mb-3">
                                                ${tagsHtml}
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>Taxonomic Classification</h6>
                                            <table class="table table-bordered">
                                                <tr><th>Domain</th><td>${data.domain_name}</td></tr>
                                                <tr><th>Kingdom</th><td>${data.kingdom_name}</td></tr>
                                                <tr><th>Phylum</th><td>${data.phylum_name}</td></tr>
                                                <tr><th>Class</th><td>${data.class_name}</td></tr>
                                                <tr><th>Order</th><td>${data.order_name}</td></tr>
                                                <tr><th>Family</th><td>${data.family_name}</td></tr>
                                                <tr><th>Genus</th><td>${data.genus_name}</td></tr>
                                                <tr><th>Species</th><td>${data.species_name}</td></tr>
                                            </table>
                                            
                                            <h6>Additional Information</h6>
                                            <table class="table table-bordered">
                                                ${data.discovery_year ? `<tr><th>Discovery Year</th><td>${data.discovery_year}</td></tr>` : ''}
                                                ${data.conservation_status ? `<tr><th>Conservation Status</th><td>${data.conservation_status}</td></tr>` : ''}
                                                ${data.habitat ? `<tr><th>Habitat</th><td>${data.habitat}</td></tr>` : ''}
                                                ${data.geographic_distribution ? `<tr><th>Geographic Distribution</th><td>${data.geographic_distribution}</td></tr>` : ''}
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    
                    const modalInstance = new bootstrap.Modal(modal);
                    modalInstance.show();
                    
                    modal.addEventListener('hidden.bs.modal', function() {
                        modal.remove();
                    });
                })
                .catch(error => {
                    console.error('Error loading species details:', error);
                });
        }
        
        // Export database
        function exportDatabase() {
            fetch('/api/export')
                .then(response => response.json())
                .then(data => {
                    alert('Database exported successfully!');
                    window.location.href = '/taxonomy_export.json';
                })
                .catch(error => {
                    console.error('Error exporting database:', error);
                    alert('Error exporting database. Please try again.');
                });
        }
        
        // Import database
        function importDatabase() {
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file to import.');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            fetch('/api/import', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    alert('Database imported successfully!');
                    window.location.reload();
                }
            })
            .catch(error => {
                console.error('Error importing database:', error);
                alert('Error importing database. Please try again.');
            });
        }
        
        // Get SQL schema
        function getSchema() {
            fetch('/api/schema')
                .then(response => response.json())
                .then(data => {
                    const schemaContent = document.getElementById('schema-content');
                    schemaContent.textContent = data.schema;
                    schemaContent.style.display = 'block';
                    
                    // Create download link
                    const downloadLink = document.createElement('a');
                    downloadLink.href = 'data:text/plain;charset=utf-8,' + encodeURIComponent(data.schema);
                    downloadLink.download = 'taxonomy_schema.sql';
                    downloadLink.className = 'btn btn-outline-primary mt-2';
                    downloadLink.textContent = 'Download SQL Schema';
                    
                    const parentElement = schemaContent.parentElement;
                    if (parentElement.querySelector('a')) {
                        parentElement.querySelector('a').remove();
                    }
                    parentElement.appendChild(downloadLink);
                })
                .catch(error => {
                    console.error('Error getting schema:', error);
                    alert('Error getting schema. Please try again.');
                });
        }
    </script>
</body>
</html>